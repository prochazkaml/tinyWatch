#include "chargen.h"
#include "oled.h"
#include <stdint.h>

const uint8_t smallfont[] = {
	0x31, 0x35, 0x53,
	0x13, 0x22, 0x53,
	0x23, 0x13, 0x43,
	0x44, 0x44, 0x44,
	0x44, 0x11, 0x33,
	0x34, 0x54, 0x44,
	0x44, 0x44, 0x41,
	0x44, 0x45, 0x44,
	0x44, 0x44, 0x34,
	0x55, 0x55, 0x43,
	0x53, 0x34, 0x25,
	0x44, 0x44, 0x34,
	0x41, 0x34, 0x25,
	0x44, 0x44, 0x44,
	0x34, 0x55, 0x54,
	0x43, 0x13, 0x40,
	
	0x00, 0x00, 0x00, //  
	0x5F,  // !
	0x03, 0x00, 0x03,    // "
	0x14, 0x7F, 0x14, 0x7F, 0x14,      // #
	0x24, 0x4A, 0xFF, 0x4A, 0x34,      // $
	0x61, 0x1C, 0x43,    // %

	0x00,  // &
	0x02, 0x05, 0x02,    // '
	0x3E, 0x41,   // (
	0x41, 0x3E,   // )
	0x14, 0x08, 0x1C, 0x08, 0x14,      // *
	0x08, 0x1C, 0x08,    // +

	0x80, 0x40,   // ,
	0x08, 0x08, 0x08,    // -
	0x40,  // .
	0x60, 0x1C, 0x03,    // /
	0x3E, 0x41, 0x41, 0x3E,     // 0
	0x42, 0x7F, 0x40,    // 1

	0x62, 0x51, 0x49, 0x46,     // 2
	0x22, 0x49, 0x49, 0x36,     // 3
	0x18, 0x14, 0x12, 0x7F,     // 4
	0x4F, 0x49, 0x49, 0x31,     // 5
	0x3E, 0x49, 0x49, 0x32,     // 6
	0x01, 0x71, 0x09, 0x07,     // 7

	0x36, 0x49, 0x49, 0x36,     // 8
	0x26, 0x49, 0x49, 0x3E,     // 9
	0x28,  // :
	0xC8,  // ;
	0x08, 0x14, 0x22,    // <
	0x14, 0x14, 0x14,    // =

	0x22, 0x14, 0x08,    // >
	0x02, 0x51, 0x09, 0x06,     // ?
	0x3E, 0x59, 0x59, 0x59, 0x46,      // @
	0x7E, 0x11, 0x11, 0x7E,     // A
	0x7F, 0x49, 0x49, 0x36,     // B
	0x3E, 0x41, 0x41, 0x22,     // C

	0x7F, 0x41, 0x41, 0x3E,     // D
	0x7F, 0x49, 0x49, 0x41,     // E
	0x7F, 0x09, 0x09, 0x01,     // F
	0x3E, 0x41, 0x49, 0x3A,     // G
	0x7F, 0x08, 0x08, 0x7F,     // H
	0x7F,  // I

	0x21, 0x41, 0x41, 0x3F,     // J
	0x7F, 0x08, 0x14, 0x63,     // K
	0x7F, 0x40, 0x40, 0x40,     // L
	0x7F, 0x02, 0x1C, 0x02, 0x7F,      // M
	0x7F, 0x02, 0x04, 0x7F,     // N
	0x3E, 0x41, 0x41, 0x3E,     // O

	0x7F, 0x11, 0x11, 0x0E,     // P
	0x3E, 0x41, 0xC1, 0xBE,     // Q
	0x7F, 0x11, 0x11, 0x6E,     // R
	0x26, 0x49, 0x49, 0x32,     // S
	0x01, 0x7F, 0x01,    // T
	0x3F, 0x40, 0x40, 0x3F,     // U

	0x07, 0x18, 0x60, 0x18, 0x07,      // V
	0x1F, 0x60, 0x18, 0x60, 0x1F,      // W
	0x63, 0x14, 0x08, 0x14, 0x63,      // X
	0x03, 0x0C, 0x70, 0x0C, 0x03,      // Y
	0x71, 0x49, 0x45, 0x43,     // Z
	0x7F, 0x41, 0x41,    // [

	0x02, 0x04, 0x08, 0x10, 0x20,      // BackSlash
	0x41, 0x41, 0x7F,    // ]
	0x02, 0x01, 0x02,    // ^
	0x80, 0x80, 0x80, 0x80,     // _
	0x01, 0x02,   // `
	0x20, 0x54, 0x54, 0x38, 0x40,      // a

	0x3F, 0x48, 0x44, 0x38,     // b
	0x38, 0x44, 0x44, 0x28,     // c
	0x38, 0x44, 0x44, 0x7F,     // d
	0x38, 0x54, 0x54, 0x18,     // e
	0x08, 0x7E, 0x09,    // f
	0x98, 0xA4, 0xA4, 0x58,     // g

	0x7F, 0x04, 0x04, 0x78,     // h
	0x7D,  // i
	0x80, 0x80, 0x7D,    // j
	0x7F, 0x10, 0x28, 0x44,     // k
	0x3F, 0x40,   // l
	0x78, 0x04, 0x18, 0x04, 0x78,      // m

	0x7C, 0x04, 0x04, 0x78,     // n
	0x38, 0x44, 0x44, 0x38,     // o
	0xFC, 0x24, 0x24, 0x18,     // p
	0x18, 0x24, 0x24, 0xFC,     // q
	0x7C, 0x08, 0x04, 0x04,     // r
	0x48, 0x54, 0x54, 0x24,     // s

	0x04, 0x3F, 0x44,    // t
	0x3C, 0x40, 0x40, 0x7C,     // u
	0x1C, 0x20, 0x40, 0x20, 0x1C,      // v
	0x1C, 0x60, 0x18, 0x60, 0x1C,      // w
	0x44, 0x28, 0x10, 0x28, 0x44,      // x
	0x9C, 0xA0, 0xA0, 0x7C,     // y

	0x64, 0x54, 0x54, 0x4C,     // z
	0x08, 0x36, 0x41,    // {
	0x7F,  // |
	0x41, 0x36, 0x08,    // }
	0x02, 0x01, 0x02, 0x01,     // ~
};

const uint8_t bigfont[] = {
	0, 21, 36, 65, 96, 129, 147, 172, 196, 217, 242, // LUT

	/*
	 * Brief explanation of the compression used:
	 * 
	 * Each character is x*20 pixels large, it is stored by column, each one takes up 3 bytes.
	 * The lowest nibble of each column (indicated below with the asterisks) has a special meaning.
	 * If it contains a number other than 0, then the decompression routine will "skip" the next N screen bytes.
	 * If it contains 15, it is treated as the character terminator.
	 * 
	 * Example:
	 * 
	 * // 0             *   1             *   2             *
	 *    0xFF, 0x81, 0x36,                   0x69, 0x42, 0xF0
	 * 
	 * Will get decompressed as:
	 * 
	 * // 0             *   1             *   2             *
	 *    0xFF, 0x81, 0x06, 0x00, 0x00, 0x00, 0x69, 0x42, 0x00
	 */

//  0             *   1             *   2             *   3             *   4             *   5             *   6             *   7             *   8             *   9             *   10            *   11            *   12            *
	0xF8, 0xFF, 0x01, 0xFC, 0xFF, 0x03, 0xFE, 0xFF, 0x67,                                     0x06, 0x00, 0x66,                                     0xFE, 0xFF, 0x07, 0xFC, 0xFF, 0x03, 0xF8, 0xFF, 0xF1, // 0
	0x00, 0x00, 0x60,                                     0x1C, 0x00, 0x00, 0x1E, 0x00, 0x00, 0xE0, 0xFF, 0x37,                   0xFE, 0xFF, 0xF7, // 1
	0x18, 0x00, 0x07, 0x0C, 0x80, 0x01, 0x06, 0xC0, 0x10,       0x60, 0x16,       0x30, 0x00, 0x06, 0x18, 0x10,       0x0C, 0x16,       0x06, 0x00, 0xFE, 0x03, 0x00, 0xFC, 0x01, 0x06, 0xF8, 0x00, 0xF6, // 2
	0x06, 0x80, 0x21,             0x03, 0x80, 0x01, 0x06, 0x46, 0x00, 0x00, 0x20, 0x00, 0x00, 0xF0, 0x01, 0x06, 0x7E, 0x00, 0x00, 0x20, 0x00, 0x00, 0x90, 0xFF, 0x07, 0x0E, 0xFF, 0x03, 0x06, 0xFE, 0xF1, // 3
	0x00, 0x1F, 0x00, 0x80, 0x03, 0x00, 0xC0, 0x01, 0x00, 0xE0, 0x18, 0x00, 0x70, 0x00, 0x00, 0x38, 0x00, 0x00, 0x1C, 0x18, 0x00, 0x0E, 0x00, 0x00, 0xFE, 0xFF, 0x37,                   0xFE, 0xFF, 0x37,                   0x00, 0x18, 0xF0, // 4
	0xFE, 0x81, 0x21,             0x03, 0xFE, 0x01, 0x66,                                     0x86, 0x01, 0x66,                                     0x86, 0xFF, 0x17,       0xFF, 0x03, 0x06, 0xFE, 0xF1, // 5
	0xC0, 0xFF, 0x01, 0xE0, 0xFF, 0x03, 0xF0, 0xFF, 0x07, 0x38, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x8E, 0x01, 0x66,                                     0x86, 0xFF, 0x17,       0xFF, 0x13,       0xFE, 0xF1, // 6
	0x06, 0x00, 0x60,                                     0x06, 0x00, 0x10,       0xF0, 0x17,       0x08, 0x00, 0x06, 0xFC, 0x07, 0x06, 0x0E, 0x00, 0xFE, 0x07, 0x10,       0x02, 0x00, 0xFE, 0x01, 0xF0, // 7
	0xF8, 0xF9, 0x01, 0xFC, 0xFF, 0x03, 0xFE, 0xFF, 0x67,                                     0x06, 0x06, 0x66,                                     0xFE, 0xFF, 0x07, 0xFC, 0xFF, 0x03, 0xF8, 0xF9, 0xF1, // 8
	0xF8, 0x07, 0x00, 0xFC, 0x0F, 0x00, 0xFE, 0x1F, 0x66,                                     0x06, 0x18, 0x17,       0x80, 0x13,       0xC0, 0x01, 0xFE, 0xFF, 0x00, 0xFC, 0x7F, 0x00, 0xF8, 0x1F, 0xF0, // 9
	0xE0, 0x81, 0x37,                   0xE0, 0x81, 0xF7, // :
};

uint8_t char_len(char c) {
	c -= 32;

	if(c & 1)
		return smallfont[c >> 1] & 0xF;
	else
		return smallfont[c >> 1] >> 4;
}

uint8_t char_draw(char c, uint8_t x, uint8_t y) {
	const uint8_t *addr = smallfont + 48;

	uint8_t w = char_len(c);

	while(c-- > 32) addr += char_len(c);

	for(uint8_t i = 0; i < w; i++) {
		uint8_t b = *addr++;

		for(uint8_t j = 0; j < 8; j++) {
			if(b & 1) oled_set_pixel(x + i, y + j);
			b >>= 1;
		}
	}

	return w;
}

uint8_t char_string_len(const char *c) {
	uint8_t x = -1;

	while(*c != 0) {
		x += char_len(*c++) + 1;
	}

	return x;
}

void char_string_draw(const char *c, uint8_t x, uint8_t y) {
	if(x == STR_CENTER) x = 64 - (char_string_len(c) >> 1);

	while(*c != 0) {
		x += char_draw(*c++, x, y) + 1;
	}
}

void char_draw_large(char c, uint8_t x, uint8_t y) {
	const uint8_t *addr = bigfont + 11 + bigfont[c];
	
	uint8_t bank = 0, b, skip = 0;

	while(skip != 0xF) {
		if(skip) {
			skip--;
		} else {
			b = *addr++;

			if(bank == 16) {
				skip = b >> 4;
				b &= 0x0F;
			}

			for(uint8_t j = 0; j < 8; j++) {
				if(b & 1) {
					for(uint8_t o = 0; o < 3; o++) oled_set_pixel(o + x, y + j + bank);
				}
				
				b >>= 1;
			}
		}

		bank += 8;

		if(bank >= 24) {
			bank = 0;
			x++;
		}
	}
}

